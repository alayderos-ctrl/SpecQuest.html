<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Level 7</title>
<style>
  body {
    margin: 0;
    background: #222;
    overflow: hidden;
    font-family: Arial, sans-serif;
  }
  #gameTitle {
    position: fixed; /* fixed at top, non-disturbable on mobile */
    top: 10px;
    width: 100%;
    text-align: center;
    color: #fff;
    font-size: 28px;
    font-weight: bold;
    z-index: 10;
    background: transparent;
  }
  #gameCanvas {
    display: block;
    margin: 50px auto 0 auto;
    background: #111;
  }
  /* Position score at bottom left corner of scenario (canvas) */
  #score {
    position: absolute;
    bottom: 10px;
    left: 10px;
    color: #fff;
    font-size: 20px;
    font-family: Arial, sans-serif;
    background: rgba(0,0,0,0.5);
    padding: 5px 10px;
    border-radius: 5px;
    z-index: 10;
  }

  /* Container for mobile controls outside the scene, fixed at bottom center */
  #mobileControls {
    position: fixed;
    bottom: 20px; /* position below the game canvas */
    left: 50%;
    transform: translateX(-50%);
    display: none; /* hidden by default, shown on mobile */
    gap: 50px;
    z-index: 10;
  }
  /* Buttons for controls */
  .control-btn {
    width: 160px;
    height: 160px;
    background: rgba(255,255,255,0.2);
    border: 2px solid #fff;
    border-radius: 50%;
    font-size: 24px;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
  }

  /* Overlay styles unchanged */
  #overlay {
    position: absolute;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.7);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #fff;
    font-family: Arial, sans-serif;
    font-size: 24px;
    z-index: 20;
    text-align: center;
    padding: 20px;
  }
  #overlay button {
    margin: 10px;
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
    border: none;
    border-radius: 5px;
  }
  #triviaText {
    margin-top: 20px;
    font-size: 20px;
  }

  /* Timer display added here */
  #gameTimer {
    position: fixed; /* changed from fixed to fixed for visibility */
    top: 50px;
    right: 20px;
    font-size: 30px;
    color: #fff;
    z-index: 20;
    font-family: Arial, sans-serif;
  }
</style>
</head>
<body>
<div id="gameTitle">Catch the Beneficial and Avoid the Harmful</div>
<!-- Instruction for players -->
<div id="gameInstruction" style="position:absolute; top:50px; width:100%; text-align:center; color:#fff; font-size:20px; z-index:10;">
  Use the arrow keys or on-screen buttons to catch beneficial EM wave objects and avoid harmful ones!
</div>

<!-- Score in bottom left corner of scenario -->
<div id="score">Score: 0</div>
<!-- Removed targetScore display -->

<canvas id="gameCanvas" width="800" height="600"></canvas>

<!-- Mobile controls container outside the scene, fixed at bottom center -->
<div id="mobileControls">
  <div class="control-btn" id="leftBtn">&#8592;</div>
  <div class="control-btn" id="rightBtn">&#8594;</div>
</div>

<div id="overlay">
  <div id="message"></div>
  <div id="triviaText" style="display:none;"></div>
  <button id="nextBtn" style="display:none;">Next Level</button>
</div>

<!-- Countdown overlay added here -->
<div id="countdownOverlay" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; font-size:80px; color:#fff; z-index:30; font-family:sans-serif; display:none;">
  <div id="countdownNumber"></div>
</div>

<!-- Timer display -->
<div id="gameTimer">Time: 20</div>

<script>
/* Parse URL parameters for previous score */
function getUrlParameter(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

// Initialize score from URL parameter or default to 0
let score = parseInt(getUrlParameter('score')) || 0;

// Update the score display
document.getElementById('score').innerText = 'Score: ' + score;

/* Game variables */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let items = [];
const totalItemsCount = 8; // reduced by 40%

// Removed targetScore
// const targetScore = 25;

const beneficialTypes = [
  { name: 'WiFi', imageSrc: 'https://i.imgur.com/4dBuUeU.png', points: 1, beneficial: true },
  { name: 'Remote Control', imageSrc: 'https://i.imgur.com/QWXmnEK.png', points: 1, beneficial: true },
  { name: 'Cell Tower', imageSrc: 'https://i.imgur.com/hExeIgg.png', points: 1, beneficial: true }
];

const hazardTypes = [
  { name: 'Radioactive Wave', imageSrc: 'https://i.imgur.com/NGlXhoM.png', points: 0, beneficial: false },
  { name: 'Microwave Hazard', imageSrc: 'https://i.imgur.com/VXIe0Ru.png', points: 0, beneficial: false },
  { name: 'X-Ray Hazard', imageSrc: 'https://i.imgur.com/NGlXhoM.png', points: 0, beneficial: false }
];

const catcherImageSrc = 'https://i.imgur.com/1YsLNys.png';

const appImagesSrc = [
  'https://i.imgur.com/4dBuUeU.png',
  'https://i.imgur.com/QWXmnEK.png',
  'https://i.imgur.com/hExeIgg.png'
];

const catcherImage = new Image();
catcherImage.src = catcherImageSrc;

const appImages = [];
for (let src of appImagesSrc) {
  const img = new Image();
  img.src = src;
  appImages.push(img);
}

function createItem(type) {
  const img = new Image();
  img.src = type.imageSrc;
  const baseSpeed = 2 + Math.random() * 2;
  return {
    x: Math.random() * (canvas.width - 50),
    y: Math.random() * -canvas.height,
    width: 50,
    height: 50,
    speed: baseSpeed * 0.8,
    image: img,
    type: type
  };
}

function generateItems() {
  for (let i=0; i<totalItemsCount; i++) {
    const isBeneficial = Math.random() < 0.7;
    const typeArr = isBeneficial ? beneficialTypes : hazardTypes;
    const type = typeArr[Math.floor(Math.random() * typeArr.length)];
    items.push(createItem(type));
  }
}
generateItems();

let catcherX = canvas.width / 2;
const catcherY = canvas.height - 80;
const catcherWidth = 80;
const catcherHeight = 80;

const catchSound = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3');

let leftPressed = false;
let rightPressed = false;

function isMobileDevice() {
  return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

if (isMobileDevice()) {
  document.getElementById('mobileControls').style.display = 'flex';
}

document.getElementById('leftBtn').addEventListener('touchstart', () => { leftPressed = true; });
document.getElementById('leftBtn').addEventListener('touchend', () => { leftPressed = false; });
document.getElementById('rightBtn').addEventListener('touchstart', () => { rightPressed = true; });
document.getElementById('rightBtn').addEventListener('touchend', () => { rightPressed = false; });

document.getElementById('leftBtn').addEventListener('mousedown', () => { leftPressed = true; });
document.getElementById('leftBtn').addEventListener('mouseup', () => { leftPressed = false; });
document.getElementById('rightBtn').addEventListener('mousedown', () => { rightPressed = true; });
document.getElementById('rightBtn').addEventListener('mouseup', () => { rightPressed = false; });

document.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') leftPressed = true;
  if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') rightPressed = true;
});
document.addEventListener('keyup', (e) => {
  if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') leftPressed = false;
  if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') rightPressed = false;
});

// Particles
const particles = [];
const maxParticles = 50;

function createParticles() {
  for (let i=0; i<maxParticles; i++) {
    particles.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.5,
      vy: (Math.random() - 0.5) * 0.5,
      size: 2 + Math.random()*2,
      alpha: 0.3 + Math.random()*0.7
    });
  }
}
createParticles();

function updateParticles() {
  for (let p of particles) {
    p.x += p.vx;
    p.y += p.vy;
    if (p.x < 0) p.x = canvas.width;
    if (p.x > canvas.width) p.x = 0;
    if (p.y < 0) p.y = canvas.height;
    if (p.y > canvas.height) p.y = 0;
  }
}

function drawParticles() {
  ctx.save();
  for (let p of particles) {
    ctx.globalAlpha = p.alpha;
    ctx.fillStyle = '#555';
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.restore();
}

const overlay = document.getElementById('overlay');
const messageDiv = document.getElementById('message');
const triviaDiv = document.getElementById('triviaText');
const nextBtn = document.getElementById('nextBtn');

document.getElementById('nextBtn').addEventListener('click', () => {
  // Pass current score to next level via URL
  window.location.href = 'level8.html?score=' + score;
});

// Function to show overlay
function showOverlay(message, options) {
  messageDiv.innerHTML = message;
  triviaDiv.style.display = 'none'; // hide trivia by default
  overlay.style.display = 'flex';
  nextBtn.style.display = options.next ? 'inline-block' : 'none';
  if (options.trivia) {
    triviaDiv.innerHTML = 'Trivia: Electromagnetic (EM) waves can influence the environment by affecting animal navigation, causing pollution, and impacting human health. Reducing EM pollution helps protect ecosystems!';
    triviaDiv.style.display = 'block';
  }
}

// Countdown elements
const countdownOverlay = document.getElementById('countdownOverlay');
const countdownNumber = document.getElementById('countdownNumber');

function startCountdown(duration, callback) {
  let timeLeft = duration;
  countdownOverlay.style.display = 'flex';
  countdownNumber.innerText = timeLeft;
  const countdownInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft > 0) {
      countdownNumber.innerText = timeLeft;
    } else {
      clearInterval(countdownInterval);
      countdownOverlay.style.display = 'none';
      callback();
    }
  }, 1000);
}

// Variables for game timing
let gameRunning = false; // start false, will set true after countdown
let gameTime = 20; // 20 seconds for game timer
let gameTimerInterval = null;

function startGameTimer(duration, onTimeUp) {
  document.getElementById('gameTimer').innerText = 'Time: ' + duration;
  gameTime = duration;

  gameTimerInterval = setInterval(() => {
    gameTime--;
    if (gameTime >= 0) {
      document.getElementById('gameTimer').innerText = 'Time: ' + gameTime;
    }
    if (gameTime <= 0) {
      clearInterval(gameTimerInterval);
      onTimeUp();
    }
  }, 1000);
}

function update() {
  // No target score logic
}

function gameOver() {
  // Clear the game timer
  clearInterval(gameTimerInterval);
  // Show game over message
  showOverlay('Time is up! Game Over!', { next: false });
  gameRunning = false;

  // Wait for 2 seconds, then redirect to next level with score
  setTimeout(() => {
    window.location.href = 'level8.html?score=' + score;
  }, 2000);
}

// Main game loop
function gameLoop() {
  if (!gameRunning) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  updateParticles();
  drawParticles();

  // Draw app images at top
  appImages.forEach((img, idx) => {
    ctx.drawImage(img, 10 + idx*110, 10, 100, 100);
  });

  // Move catcher
  if (leftPressed && catcherX > 0) catcherX -= 5;
  if (rightPressed && catcherX + catcherWidth < canvas.width) catcherX += 5;
  ctx.drawImage(catcherImage, catcherX, catcherY, catcherWidth, catcherHeight);

  // Update and draw items
  for (let i=items.length -1; i>=0; i--) {
    const item = items[i];
    item.y += item.speed;
    ctx.drawImage(item.image, item.x, item.y, item.width, item.height);

    // Collision detection
    if (
      item.y + item.height > catcherY &&
      item.x < catcherX + catcherWidth &&
      item.x + item.width > catcherX
    ) {
      if (item.type.beneficial) {
        handleBeneficialCatch();
        resetItem(item);
      } else {
        handleHarmfulCatch();
        resetItem(item);
      }
    }

    // Reset if off-screen
    if (item.y > canvas.height) {
      if (item.type.beneficial) {
        handleBeneficialMiss();
      }
      resetItem(item);
    }
  }

  update();

  if (gameRunning) {
    requestAnimationFrame(gameLoop);
  }
}

// Reset item position
function resetItem(item) {
  item.x = Math.random() * (canvas.width - 50);
  item.y = -item.height;
}

// For timing-based scoring
let beneficialCatchCounter = 0;
let harmfulCatchCounter = 0;

function handleBeneficialCatch() {
  beneficialCatchCounter++;
  if (beneficialCatchCounter >= 4) {
    score += 1;
    document.getElementById('score').innerText = 'Score: ' + score;
    beneficialCatchCounter = 0; // reset counter after increment
  }
  catchSound.currentTime = 0;
  catchSound.play();
}

function handleBeneficialMiss() {
  // optional: do nothing
}

function handleHarmfulCatch() {
  harmfulCatchCounter++;
  if (harmfulCatchCounter >= 3) {
    score -= 1;
    if (score < 0) score = 0;
    document.getElementById('score').innerText = 'Score: ' + score;
  }
  // No game over here
}

// Start the countdown and then the game
startCountdown(3, () => {
  // Initialize catcher position
  catcherX = canvas.width / 2;
  // Start game timer
  startGameTimer(20, () => {
    // Time's up, end the game
    gameOver();
  });
  gameRunning = true;
  gameLoop();
});
</script>
</body>
</html>